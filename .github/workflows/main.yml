name: Create release

on:
  workflow_dispatch:
    inputs:
      artifactId:
        description: 'Artifact ID'
        required: true

jobs:
  createRelease:
    name: Download artifact and create release
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifact
        id: download_artifact
        run: |
          artifact_url="https://api.github.com/repos/kapslocker/nli/actions/artifacts/${{ github.event.inputs.artifactId}}/zip"
          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -L $artifact_url -o treewhl.zip
          unzip treewhl.zip
          version=$(echo *.whl | cut -d'-' -f2)
          # extract base version, branch version and run_number
          run_number=${version##*.}
          rem_ver=${version:0:${#version} - ${#run_number} - 1}
          branch_version=${rem_ver##*.}
          base_version=${rem_ver:0:${#rem_ver} - ${#branch_version} - 1}
          echo $runNumber > $branch_version
          echo "::set-output name=version::$version"
          echo "::set-output name=base_version::$base_version"
          echo "::set-output name=branch_version::$branch_version"
      - name: Login to azure
        uses: azure/login@v1.1
        with:
          creds: ${{ secrets.RELEASE_PIPELINE_AZ_CLI_SECRET }}
      
      - name: Update version metadata
        uses: azure/CLI@v1
        with:
          inlineScript: |
            base_version_output=${{ steps.download_artifact.outputs.base_version }}
            base_version=${base_version_output//./-}
            branch_version=${{ steps.download_artifact.outputs.branch_version }}
            az storage container create --account-name aidlsclimetadata --name $base_version --public-access container
            az storage blob upload --account-name aidlsclimetadata  -c $base_version -f "$branch_version" -n $branch_version
      - name: Create release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: "${{ steps.download_artifact.outputs.version }}"
          release_name: Release ${{ steps.download_artifact.outputs.version }}
          draft: false
          prerelease: false
      - name: Upload release asset
        id: upload-release-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: treewhl.zip
          asset_name: treewhl.zip
          asset_content_type: application/zip
